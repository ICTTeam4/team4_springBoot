<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.saintkream.server.domain.salepage.mapper.SalePageMapper">

<!-- 특정 회원의 판매 페이지 데이터 조회 -->
    <select id="getSalePageData" resultType="com.saintkream.server.domain.salepage.vo.SalePageVO">
        SELECT 
            m.member_id AS memberId,
            m.nickname AS nickname,
            r.content AS content,
            ROUND(AVG(r.rate), 1) AS rate, -- 평균 평점
            f.file_name AS fileName
        FROM members m
        LEFT JOIN reviews r ON m.member_id = r.member_id
        LEFT JOIN review_file rf ON r.review_id = rf.review_id
        LEFT JOIN file_table f ON rf.file_id = f.file_id
        WHERE m.member_id = #{member_id}
        GROUP BY m.member_id, m.nickname, r.content, f.file_name
    </select>

    <select id="getSaleTabPageDataList" resultType="com.saintkream.server.domain.salepage.vo.SaleTabPageVO" resultMap="PageTabWithFilesMap" parameterType="int">
        SELECT 
            p.pwr_id AS pwr_id, 
            f.file_name AS file_name,
            p.title AS title,
            p.sell_price AS sell_price,
            p.created_at AS created_at,
            p.status AS status,
            td.trans_date AS trans_date
        FROM post p
        LEFT JOIN post_files pf ON p.pwr_id = pf.pwr_id
        LEFT JOIN file_table f ON pf.file_id = f.file_id
        LEFT JOIN transactiondetails td ON p.pwr_id = td.pwr_id
        WHERE p.member_id = #{member_id}
        ORDER BY p.created_at DESC
    </select>
    <resultMap id="PageTabWithFilesMap" type="SaleTabPageVO">
    <!-- PostVO의 기본 필드 -->
    <id property="pwr_id" column="pwr_id" />
    <result property="title" column="title" />
    <result property="sell_price" column="sell_price"/>
    <result property="created_at" column="created_at"/>
    <result property="status" column="status" />
    <result property="trans_date" column="trans_date" />
    <result property="member_id" column="member_id" />

    <!-- FileVO 리스트를 매핑 -->
    <collection property="fileList" ofType="FileVO">
        <result property="fileName" column="file_name" />
    </collection>
  </resultMap>
</mapper>
